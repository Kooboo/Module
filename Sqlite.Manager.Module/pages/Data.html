<!-- #layout name=blank -->
<div id="app">
  <div class="page-header">
    <h1 class="title">Data</h1>
  </div>
  <kb-breadcrumb :breads="breads"></kb-breadcrumb>
  <div class="navbar navbar-default">
    <div class="container-fluid">
      <a href="javascript:;" class="btn green navbar-btn" :href="createDataUrl"
        >New data</a
      >
      <a
        v-show="selectedRows.length"
        @click="onDelete"
        class="btn red navbar-btn"
        >Delete</a
      >
      <a
        :href="columnsPageUrl"
        v-kb-tooltip:left="Kooboo.text.tooltip.columnSetting"
        class="btn btn-default navbar-btn pull-right"
        ><i class="fa fa-gear"></i
      ></a>
    </div>
  </div>
  <kb-table :data="list" show-select :selected.sync="selectedRows">
    <kb-table-column v-for="item in listKeys" :prop="item" :label="item">
    </kb-table-column>
    <kb-table-column width="100px" align="right">
      <template v-slot="row">
        <a class="btn btn-ms blue" :href="editUrl(row._id)" @click.stop=""
          >{{Kooboo.text.common.edit}}</a
        >
      </template>
    </kb-table-column>
  </kb-table>
  <kb-pager
    :page-nr="model.pageNr"
    :total-pages="model.totalPages"
    @change="getData"
  ></kb-pager>
</div>
<script src="js/main.js"></script>
<script>
  Kooboo.loadJS([
    "/_Admin/Scripts/components/kbBreadcrumb.js",
    "/_Admin/Scripts/components/kbTable.js",
    "/_Admin/Scripts/components/kbPager.js"
  ]);
  new Vue({
    el: "#app",
    data: function() {
      return {
        breads: [
          {
            name: "SITES"
          },
          {
            name: "DASHBOARD"
          },
          {
            name: "Sqlite",
            url: koobooModule.recombineUrl(
              koobooModule.getModuleRootPath() + "/index.html",
              { SiteId: Kooboo.getQueryString("SiteId") }
            )
          },
          {
            name: Kooboo.getQueryString("table")
          }
        ],
        siteId: Kooboo.getQueryString("SiteId"),
        selectedRows: [],
        model: {}
      };
    },
    computed: {
      createDataUrl: function() {
        return koobooModule.recombineUrl(
          koobooModule.getModuleRootPath() + "/pages/EditData.html",
          { SiteId: this.siteId, table: Kooboo.getQueryString("table") }
        );
      },
      columnsPageUrl: function() {
        return koobooModule.recombineUrl(
          koobooModule.getModuleRootPath() + "/pages/Columns.html",
          {
            SiteId: this.siteId,
            table: Kooboo.getQueryString("table"),
            from: "Data"
          }
        );
      },

      listKeys: function() {
        var keys = [];
        if (this.model.list) {
          this.model.list.forEach(function(item) {
            item.forEach(function(i) {
              if (i.key != "_id" && keys.indexOf(i.key) == -1) {
                keys.push(i.key);
              }
            });
          });
        }
        return keys;
      },
      list: function() {
        var items = [];
        if (this.model.list) {
          this.model.list.forEach(function(item) {
            var obj = {};
            item.forEach(function(i) {
              obj[i.key] = i.value;
            });
            items.push(obj);
          });
        }
        return items;
      }
    },
    mounted: function() {
      this.getData();
    },
    methods: {
      onDelete: function() {
        var me = this;
        if (confirm(Kooboo.text.confirm.deleteItems)) {
          var ids = me.selectedRows.map(function(o) {
            return o._id;
          });

          this.$httpClient
            .post(
              "Sqlite/DeleteData",
              {
                tableName: Kooboo.getQueryString("table"),
                values: ids
              },
              {
                SiteId: me.siteId
              }
            )
            .then(function(res) {
              if (res.status === 200 && res.data.success) {
                me.getData();
                window.info.done(Kooboo.text.info.delete.success);
              }
            });
        }
      },
      editUrl: function(id) {
        var me = this;
        return koobooModule.recombineUrl(
          koobooModule.getModuleRootPath() + "/pages/EditData.html",
          {
            SiteId: me.siteId,
            id: id,
            table: Kooboo.getQueryString("table")
          }
        );
      },
      getData: function(pageNr) {
        var me = this;
        this.$httpClient
          .get("Sqlite/Data", {
            SiteId: me.siteId,
            table: Kooboo.getQueryString("table"),
            pageNr: pageNr || 1
          })
          .then(function(res) {
            if (res.status === 200 && res.data.success) {
              me.model = res.data.model;
            }
          });
      }
    }
  });
</script>
